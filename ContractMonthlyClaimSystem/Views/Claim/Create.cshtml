@model ContractMonthlyClaimSystem.Models.ViewModels.SubmitClaimViewModel
@{
    ViewData["Title"] = "Submit New Claim";
}

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Submit New Claim
                </h3>
                <span class="badge bg-light text-primary">Draft</span>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data" id="claimForm">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ClaimPeriod" class="form-label fw-bold">Claim Period *</label>
                                <input asp-for="ClaimPeriod" type="month" class="form-control"
                                       min="@DateTime.Now.AddMonths(-12).ToString("yyyy-MM")"
                                       max="@DateTime.Now.ToString("yyyy-MM")" />
                                <span asp-validation-for="ClaimPeriod" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HoursWorked" class="form-label fw-bold">Hours Worked *</label>
                                <input asp-for="HoursWorked" class="form-control" min="0.5" max="200" step="0.5" />
                                <span asp-validation-for="HoursWorked" class="text-danger small"></span>
                                <div class="form-text">Enter hours in 0.5 increments (e.g., 1.5, 2.0, 2.5)</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HourlyRate" class="form-label fw-bold">Hourly Rate (R) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">R</span>
                                    <input asp-for="HourlyRate" class="form-control" min="50" max="500" step="0.01" />
                                </div>
                                <span asp-validation-for="HourlyRate" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Total Amount</label>
                                <div class="p-3 bg-light rounded border">
                                    <div class="h4 text-success mb-0 text-center" id="totalAmountDisplay">
                                        R 0.00
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label fw-bold">Work Description *</label>
                        <textarea asp-for="Description" class="form-control" rows="4"
                                  placeholder="Please provide a detailed description of the work performed, including specific tasks, deliverables, and any relevant details..."></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                        <div class="form-text">
                            <span id="charCount">0</span>/500 characters
                        </div>
                    </div>

                    <div class="mb-4">
                        <label asp-for="SupportingDocument" class="form-label fw-bold">Supporting Document</label>
                        <input asp-for="SupportingDocument" type="file" class="form-control"
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                        <span asp-validation-for="SupportingDocument" class="text-danger small"></span>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Supported formats: PDF, Word (DOC/DOCX), JPG, PNG (Max: 10MB)
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Recommended documents:</strong> Timesheets, work reports, completion certificates, or photos of work completed.
                            </small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Submission Guidelines</h6>
                        <ul class="mb-0 small">
                            <li>All fields marked with * are required</li>
                            <li>Claims are processed within 5-7 working days</li>
                            <li>You will be notified via email about the status of your claim</li>
                            <li>Ensure all information is accurate before submission</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                        <a href="@Url.Action("Index", "Claim")" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Claims
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-warning me-2" onclick="saveAsDraft()">
                                <i class="fas fa-save me-1"></i>Save Draft
                            </button>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-paper-plane me-1"></i>Submit Claim
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Auto-calculate total amount
        function calculateTotal() {
            const hours = parseFloat(document.getElementById('HoursWorked').value) || 0;
            const rate = parseFloat(document.getElementById('HourlyRate').value) || 0;
            const total = hours * rate;

            const totalDisplay = document.getElementById('totalAmountDisplay');
            if (totalDisplay) {
                totalDisplay.textContent = 'R ' + total.toLocaleString('en-MY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // Character count for description
        function updateCharCount() {
            const description = document.getElementById('Description');
            const charCount = document.getElementById('charCount');
            if (description && charCount) {
                charCount.textContent = description.value.length;
                if (description.value.length > 500) {
                    charCount.classList.add('text-danger');
                } else {
                    charCount.classList.remove('text-danger');
                }
            }
        }

        // File size validation
        function validateFile(input) {
            if (input.files && input.files[0]) {
                const fileSize = input.files[0].size / 1024 / 1024; // MB
                const maxSize = 10;

                if (fileSize > maxSize) {
                    alert(`File size must be less than ${maxSize}MB. Your file is ${fileSize.toFixed(2)}MB.`);
                    input.value = '';
                }
            }
        }

        // Save as draft functionality
        function saveAsDraft() {
            const form = document.getElementById('claimForm');
            const draftButton = form.querySelector('button[type="submit"]');

            // Add draft indicator
            const draftInput = document.createElement('input');
            draftInput.type = 'hidden';
            draftInput.name = 'IsDraft';
            draftInput.value = 'true';
            form.appendChild(draftInput);

            form.submit();
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const hoursInput = document.getElementById('HoursWorked');
            const rateInput = document.getElementById('HourlyRate');
            const descriptionInput = document.getElementById('Description');
            const fileInput = document.getElementById('SupportingDocument');

            // Calculate initial total
            calculateTotal();

            // Add event listeners
            if (hoursInput) hoursInput.addEventListener('input', calculateTotal);
            if (rateInput) rateInput.addEventListener('input', calculateTotal);
            if (descriptionInput) descriptionInput.addEventListener('input', updateCharCount);
            if (fileInput) fileInput.addEventListener('change', function() { validateFile(this); });

            // Set default claim period to current month if not set
            const claimPeriodInput = document.getElementById('ClaimPeriod');
            if (claimPeriodInput && !claimPeriodInput.value) {
                const now = new Date();
                claimPeriodInput.value = now.toISOString().substring(0, 7);
            }
        });
    </script>
}